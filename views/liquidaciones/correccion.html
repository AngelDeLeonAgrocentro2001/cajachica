<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corrección de Facturas</title>
    <style>
        body {
            background-color: #f4f7fa;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            width: 100vw;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
            box-sizing: border-box;
        }

        h2 {
            text-align: center;
            color: #2c3e50;
            margin: 30px 0;
            font-size: 2rem;
            font-weight: 600;
        }

        h3 {
            color: #2c3e50;
            margin: 20px 0 10px;
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
        }

        p {
            text-align: center;
            color: #333;
            font-size: 1rem;
            margin: 5px 0;
        }

        p strong {
            color: #2c3e50;
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            margin: 30px 0;
            -webkit-overflow-scrolling: touch;
        }

        #facturasTable {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin: 0 auto;
        }

        #facturasTable thead {
            background-color: #2c3e50;
            color: #fff;
        }

        #facturasTable th,
        #facturasTable td {
            padding: 12px 15px;
            text-align: left;
            font-size: 0.95rem;
            min-width: 100px;
        }

        #facturasTable th {
            font-weight: 600;
        }

        #facturasTable tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.3s ease;
        }

        #facturasTable tbody tr:hover {
            background-color: #f9f9f9;
        }

        #facturasTable td {
            color: #333;
        }

        #facturasTable button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 5px;
            transition: background-color 0.3s ease;
        }

        #facturasTable button.edit-btn {
            background-color: #3498db;
            color: #fff;
        }

        #facturasTable button.edit-btn:hover {
            background-color: #2980b9;
        }

        #facturaForm {
            width: 100%;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            box-sizing: border-box;
        }

        #facturaForm div {
            flex: 1 1 200px;
        }

        #facturaForm label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 600;
        }

        #facturaForm input,
        #facturaForm select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        #facturaForm input:focus,
        #facturaForm select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        #facturaForm button {
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        #facturaForm button[type="submit"] {
            background-color: #3498db;
            color: #fff;
        }

        #facturaForm button[type="submit"]:hover {
            background-color: #2980b9;
        }

        #facturaForm button[type="button"] {
            background-color: #e74c3c;
            color: #fff;
        }

        #facturaForm button[type="button"]:hover {
            background-color: #c0392b;
        }

        .buttons {
            width: 100%;
            margin: 20px 0;
            text-align: right;
        }

        .buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }

        .buttons button.submit-corrections-btn {
            background-color: #27ae60;
            color: #fff;
        }

        .buttons button.submit-corrections-btn:hover {
            background-color: #219653;
        }

        .buttons button.cancel-btn {
            background-color: #e74c3c;
            color: #fff;
        }

        .buttons button.cancel-btn:hover {
            background-color: #c0392b;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }

            .table-wrapper {
                margin: 20px 0;
                overflow-x: hidden;
            }

            #facturasTable {
                min-width: 100%;
                margin: 0;
            }

            #facturasTable thead {
                display: none;
            }

            #facturasTable tbody tr {
                display: block;
                margin-bottom: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                background-color: #fff;
            }

            #facturasTable tbody td {
                display: block;
                text-align: right;
                padding: 8px 10px;
                font-size: 0.9rem;
                position: relative;
                border-bottom: 1px solid #eee;
            }

            #facturasTable tbody td:last-child {
                border-bottom: none;
            }

            #facturasTable tbody td:before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                font-weight: 600;
                color: #2c3e50;
            }

            #facturaForm {
                flex-direction: column;
                margin: 20px 0;
                padding: 15px;
            }

            #facturaForm div {
                flex: 1 1 100%;
            }

            .buttons {
                text-align: center;
            }

            .buttons button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <?php include '../views/partials/menu.php'; ?>
        <h2>Corrección de Facturas - Liquidación ID: <?php echo htmlspecialchars($data['id']); ?></h2>
        <p><strong>Caja Chica:</strong> <?php echo htmlspecialchars($data['nombre_caja_chica']); ?></p>
        <p><strong>Fecha Creación:</strong> <?php echo htmlspecialchars($data['fecha_creacion']); ?></p>
        <p><strong>Monto Total:</strong> <?php echo htmlspecialchars($data['monto_total']); ?></p>
        <p><strong>Estado:</strong> <?php echo htmlspecialchars($data['estado']); ?></p>
        <h3>Facturas Pendientes de Corrección</h3>
        <div class="table-wrapper">
            <table id="facturasTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tipo de Documento</th>
                        <th>Número Factura</th>
                        <th>Proveedor</th>
                        <th>NIT</th>
                        <th>DPI</th>
                        <th>Cantidad</th>
                        <th>Serie</th>
                        <th>Centro de Costo</th>
                        <th>Tipo de Gasto</th>
                        <th>Tipo de Combustible</th>
                        <th>Cuenta Contable</th>
                        <th>Fecha</th>
                        <th>Subtotal</th>
                        <th>IVA</th>
                        <th>IDP</th>
                        <th>INGUAT</th>
                        <th>Total Factura</th>
                        <th>Estado</th>
                        <th>Archivos</th>
                        <th>Comentario</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($detalles as $detalle): ?>
                        <tr data-id="<?php echo htmlspecialchars($detalle['id']); ?>">
                            <td data-label="ID"><?php echo htmlspecialchars($detalle['id']); ?></td>
                            <td data-label="Tipo de Documento"><?php echo htmlspecialchars($detalle['tipo_documento'] ?? 'N/A'); ?></td>
                            <td data-label="Número Factura"><?php echo htmlspecialchars($detalle['no_factura'] ?? 'N/A'); ?></td>
                            <td data-label="Proveedor"><?php echo htmlspecialchars($detalle['nombre_proveedor'] ?? 'N/A'); ?></td>
                            <td data-label="NIT"><?php echo htmlspecialchars($detalle['nit_proveedor'] ?? 'N/A'); ?></td>
                            <td data-label="DPI"><?php echo htmlspecialchars($detalle['dpi'] ?? 'N/A'); ?></td>
                            <td data-label="Cantidad"><?php echo htmlspecialchars($detalle['cantidad'] ?? 'N/A'); ?></td>
                            <td data-label="Serie"><?php echo htmlspecialchars($detalle['serie'] ?? 'N/A'); ?></td>
                            <td data-label="Centro de Costo"><?php echo htmlspecialchars($detalle['nombre_centro_costo'] ?? 'N/A'); ?></td>
                            <td data-label="Tipo de Gasto"><?php echo htmlspecialchars($detalle['t_gasto'] ?? 'N/A'); ?></td>
                            <td data-label="Tipo de Combustible"><?php echo htmlspecialchars($detalle['tipo_combustible'] ?? 'N/A'); ?></td>
                            <td data-label="Cuenta Contable"><?php echo htmlspecialchars($detalle['cuenta_contable'] ?? 'N/A'); ?></td>
                            <td data-label="Fecha"><?php echo htmlspecialchars($detalle['fecha'] ?? 'N/A'); ?></td>
                            <td data-label="Subtotal"><?php echo isset($detalle['p_unitario']) ? number_format($detalle['p_unitario'], 2) : 'N/A'; ?></td>
                            <td data-label="IVA"><?php echo isset($detalle['iva']) ? number_format($detalle['iva'], 2) : '0.00'; ?></td>
                            <td data-label="IDP"><?php echo isset($detalle['idp']) ? number_format($detalle['idp'], 2) : '0.00'; ?></td>
                            <td data-label="INGUAT"><?php echo isset($detalle['inguat']) ? number_format($detalle['inguat'], 2) : '0.00'; ?></td>
                            <td data-label="Total Factura"><?php echo isset($detalle['total_factura']) ? number_format($detalle['total_factura'], 2) : 'N/A'; ?></td>
                            <td data-label="Estado"><?php echo htmlspecialchars($detalle['estado'] ?? 'N/A'); ?></td>
                            <td data-label="Archivos">
                                <?php
                                $rutas = !empty($detalle['rutas_archivos']) ? json_decode($detalle['rutas_archivos'], true) : [];
                                if (is_array($rutas) && !empty($rutas)) {
                                    foreach ($rutas as $ruta) {
                                        echo '<div><a href="../' . htmlspecialchars($ruta) . '" target="_blank">Ver Archivo</a></div>';
                                    }
                                } else {
                                    echo 'N/A';
                                }
                                ?>
                            </td>
                            <td data-label="Comentario"><?php echo htmlspecialchars($detalle['correccion_comentario'] ?? 'N/A'); ?></td>
                            <td data-label="Acciones">
                                <button class="edit-btn" onclick="editFactura(<?php echo htmlspecialchars(json_encode($detalle)); ?>)">Editar</button>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        <form id="facturaForm" enctype="multipart/form-data">
            <input type="hidden" name="action" value="update">
            <input type="hidden" name="detalle_id" id="detalle_id">
            <div>
                <label for="tipo_documento">Tipo de Documento:</label>
                <select name="tipo_documento" id="tipo_documento" required>
                    <option value="FACTURA">Factura</option>
                    <option value="RECIBO">Recibo</option>
                    <option value="COMPROBANTE">Comprobante</option>
                </select>
            </div>
            <div>
                <label for="no_factura">Número de Factura:</label>
                <input type="text" name="no_factura" id="no_factura" required>
            </div>
            <div>
                <label for="nombre_proveedor">Proveedor:</label>
                <input type="text" name="nombre_proveedor" id="nombre_proveedor" required>
            </div>
            <div id="nit_dpi_fields">
                <label for="nit_dpi_input" id="nit_dpi_label">NIT:</label>
                <input type="text" id="nit_dpi_input">
                <input type="hidden" name="nit_proveedor" id="nit_proveedor">
                <input type="hidden" name="dpi" id="dpi">
            </div>
            <div id="comprobante_fields" style="display: none;">
                <label for="serie">Serie:</label>
                <input type="text" name="serie" id="serie">
            </div>
            <div id="cantidad_field" style="display: none;">
                <label for="cantidad">Cantidad (Galones):</label>
                <input type="number" name="cantidad" id="cantidad" step="0.01">
            </div>
            <div>
                <label for="t_gasto">Tipo de Gasto:</label>
                <select name="t_gasto" id="t_gasto" required>
                    <?php echo $select_tipos_gastos; ?>
                </select>
            </div>
            <div id="tipo_combustible_field" style="display: none;">
                <label for="tipo_combustible">Tipo de Combustible:</label>
                <select name="tipo_combustible" id="tipo_combustible">
                    <option value="Gasolina">Gasolina</option>
                    <option value="Diesel">Diesel</option>
                </select>
            </div>
            <div>
                <label for="fecha">Fecha:</label>
                <input type="date" name="fecha" id="fecha" min="<?php echo htmlspecialchars($data['fecha_inicio']); ?>" max="<?php echo htmlspecialchars($data['fecha_fin']); ?>" required>
            </div>
            <div>
                <label for="total_factura">Total Factura (con impuestos):</label>
                <input type="number" name="total_factura" id="total_factura" step="0.01" required>
            </div>
            <div id="tax_fields" style="display: none;">
                <div id="iva_field">
                    <label for="iva">IVA:</label>
                    <input type="number" name="iva" id="iva" step="0.01" readonly>
                </div>
                <div id="idp_field">
                    <label for="idp">IDP:</label>
                    <input type="number" name="idp" id="idp" step="0.01" readonly>
                </div>
                <div id="inguat_field">
                    <label for="inguat">INGUAT:</label>
                    <input type="number" name="inguat" id="inguat" step="0.01" readonly>
                </div>
            </div>
            <div>
                <label for="subtotal">Subtotal (sin impuestos):</label>
                <input type="number" name="subtotal" id="subtotal" step="0.01" readonly>
            </div>
            <div>
                <label for="id_centro_costo">Centro de Costo:</label>
                <select name="id_centro_costo" id="id_centro_costo" required>
                    <?php echo $select_centros_costos; ?>
                </select>
            </div>
            <div>
                <label for="cuenta_contable">Cuenta Contable:</label>
                <select name="cuenta_contable" id="cuenta_contable" required>
                    <option value="">Selecciona una cuenta contable</option>
                </select>
            </div>
            <div>
                <label for="archivos">Archivos:</label>
                <input type="file" name="archivos[]" id="archivos" multiple accept=".pdf,.png,.jpg,.jpeg">
            </div>
            <div style="flex: 1 1 100%; text-align: right;">
                <button type="submit">Guardar Cambios</button>
                <button type="button" onclick="resetForm()">Cancelar</button>
            </div>
        </form>
        <div class="buttons">
            <button class="submit-corrections-btn" onclick="submitCorrections()">Enviar Correcciones</button>
            <button class="cancel-btn" onclick="window.location.href='index.php?controller=liquidacion&action=list&mode=correccion'">Volver</button>
        </div>
    </div>
    <script>
        const fechaInicioLiquidacion = '<?php echo htmlspecialchars($data['fecha_inicio']); ?>';
        const fechaFinLiquidacion = '<?php echo htmlspecialchars($data['fecha_fin']); ?>';

        function validateFileTypes(files) {
            const allowedExtensions = ['pdf', 'png', 'jpg', 'jpeg'];
            for (let file of files) {
                const extension = file.name.split('.').pop().toLowerCase();
                if (!allowedExtensions.includes(extension)) {
                    return false;
                }
            }
            return true;
        }

        const fileInput = document.getElementById('archivos');
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                if (!validateFileTypes(files)) {
                    alert('Solo se permiten archivos PDF, PNG y JPG.');
                    fileInput.value = '';
                }
            }
        });

        const impuestosPorTipoGasto = {
            'Gasto Operativo': { iva: 12, idp: 4.70, inguat: 0, cuenta_contable: 'Cuenta 1 - Centro 1' },
            'Combustible': { iva: 12, idp_gasolina: 4.70, idp_diesel: 2.00, inguat: 0, cuenta_contable: 'Cuenta 1 - Centro 1' },
            'Hotel': { iva: 12, idp: 0, inguat: 10, cuenta_contable: 'Cuenta 2 - Centro 1' },
            'Alimentos': { iva: 12, idp: 0, inguat: 0, cuenta_contable: 'Cuenta 3 - Centro 1' },
            'Otros': { iva: 12, idp: 0, inguat: 0, cuenta_contable: 'Cuenta 4 - Centro 1' }
        };

        const cuentasPorCentroCosto = {
            '1': [
                { id: 1, nombre: 'Cuenta 1 - Centro 1' },
                { id: 2, nombre: 'Cuenta 2 - Centro 1' }
            ],
            '2': [
                { id: 3, nombre: 'Cuenta 3 - Centro 2' },
                { id: 4, nombre: 'Cuenta 4 - Centro 2' }
            ]
        };

        function updateTaxFieldsVisibility(tipoDocumento = null, tipoGasto = null) {
            const tipoDocumentoSelect = document.getElementById('tipo_documento');
            const tipoGastoSelect = document.getElementById('t_gasto');
            const currentTipoDocumento = tipoDocumento || tipoDocumentoSelect.value || '';
            const currentTipoGasto = tipoGasto || tipoGastoSelect.value || '';

            const ivaField = document.getElementById('iva_field');
            const idpField = document.getElementById('idp_field');
            const inguatField = document.getElementById('inguat_field');

            if (currentTipoDocumento.toUpperCase() !== 'FACTURA') {
                ivaField.style.display = 'none';
                idpField.style.display = 'none';
                inguatField.style.display = 'none';
                return;
            }

            const impuestos = impuestosPorTipoGasto[currentTipoGasto] || { iva: 0, idp: 0, idp_gasolina: 0, idp_diesel: 0, inguat: 0 };
            ivaField.style.display = impuestos.iva > 0 ? 'block' : 'none';
            idpField.style.display = (impuestos.idp > 0 || impuestos.idp_gasolina > 0 || impuestos.idp_diesel > 0) ? 'block' : 'none';
            inguatField.style.display = impuestos.inguat > 0 ? 'block' : 'none';
        }

        function updateForm_FIELDS(tipoDocumento = null) {
            const tipoDocumentoSelect = document.getElementById('tipo_documento');
            const nitDpiLabel = document.getElementById('nit_dpi_label');
            const nitDpiInput = document.getElementById('nit_dpi_input');
            const nitInput = document.getElementById('nit_proveedor');
            const dpiInput = document.getElementById('dpi');
            const comprobanteFields = document.getElementById('comprobante_fields');
            const taxFields = document.getElementById('tax_fields');
            const serieInput = document.getElementById('serie');
            const tGastoSelect = document.getElementById('t_gasto');

            const currentTipoDocumento = tipoDocumento || tipoDocumentoSelect.value || '';

            if (currentTipoDocumento.toUpperCase() === 'RECIBO') {
                nitDpiLabel.textContent = 'DPI:';
                nitDpiInput.setAttribute('required', 'required');
                nitInput.value = '';
                dpiInput.value = nitDpiInput.value || '';
            } else {
                nitDpiLabel.textContent = 'NIT:';
                nitDpiInput.setAttribute('required', 'required');
                dpiInput.value = '';
                nitInput.value = nitDpiInput.value || '';
            }

            if (currentTipoDocumento.toUpperCase() === 'COMPROBANTE') {
                comprobanteFields.style.display = 'block';
                serieInput.setAttribute('required', 'required');
            } else {
                comprobanteFields.style.display = 'none';
                serieInput.removeAttribute('required');
                serieInput.value = serieInput.value || '';
            }

            if (currentTipoDocumento.toUpperCase() === 'FACTURA') {
                taxFields.style.display = 'block';
                updateTaxFieldsVisibility(currentTipoDocumento, tGastoSelect.value);
                updateCantidadField(currentTipoDocumento, tGastoSelect.value);
                updateTipoCombustibleField(currentTipoDocumento, tGastoSelect.value);
                updateTaxesAndTotal();
            } else {
                taxFields.style.display = 'none';
                document.getElementById('iva_field').style.display = 'none';
                document.getElementById('idp_field').style.display = 'none';
                document.getElementById('inguat_field').style.display = 'none';
                document.getElementById('cantidad_field').style.display = 'none';
                document.getElementById('cantidad').removeAttribute('required');
                document.getElementById('tipo_combustible_field').style.display = 'none';
                document.getElementById('tipo_combustible').removeAttribute('required');
                document.getElementById('iva').value = '';
                document.getElementById('idp').value = '';
                document.getElementById('inguat').value = '';
                document.getElementById('subtotal').value = document.getElementById('total_factura').value || 0;
            }
        }

        function handleNitDpiInput() {
            const tipoDocumentoSelect = document.getElementById('tipo_documento');
            const nitDpiInput = document.getElementById('nit_dpi_input');
            const nitInput = document.getElementById('nit_proveedor');
            const dpiInput = document.getElementById('dpi');

            const currentTipoDocumento = tipoDocumentoSelect.value ? tipoDocumentoSelect.value.toUpperCase() : '';
            if (currentTipoDocumento === 'RECIBO') {
                dpiInput.value = nitDpiInput.value || '';
                nitInput.value = '';
            } else {
                nitInput.value = nitDpiInput.value || '';
                dpiInput.value = '';
            }
        }

        function updateCantidadField(tipoDocumento = null, tipoGasto = null) {
            const tipoDocumentoSelect = document.getElementById('tipo_documento');
            const tipoGastoSelect = document.getElementById('t_gasto');
            const cantidadField = document.getElementById('cantidad_field');
            const cantidadInput = document.getElementById('cantidad');

            const currentTipoDocumento = tipoDocumento || tipoDocumentoSelect.value || '';
            const currentTipoGasto = tipoGasto || tipoGastoSelect.value || '';

            if (currentTipoDocumento.toUpperCase() === 'COMPROBANTE' || (currentTipoDocumento.toUpperCase() === 'FACTURA' && (currentTipoGasto === 'Combustible' || currentTipoGasto === 'Gasto Operativo'))) {
                cantidadField.style.display = 'block';
                cantidadInput.setAttribute('required', 'required');
            } else {
                cantidadField.style.display = 'none';
                cantidadInput.removeAttribute('required');
                cantidadInput.value = '';
            }

            updateTaxesAndTotal();
        }

        function updateTipoCombustibleField(tipoDocumento = null, tipoGasto = null) {
            const tipoGastoSelect = document.getElementById('t_gasto');
            const tipoCombustibleField = document.getElementById('tipo_combustible_field');
            const tipoCombustibleSelect = document.getElementById('tipo_combustible');
            const tipoDocumentoSelect = document.getElementById('tipo_documento');

            const currentTipoDocumento = tipoDocumento || tipoDocumentoSelect.value || '';
            const currentTipoGasto = tipoGasto || tipoGastoSelect.value || '';

            if (currentTipoDocumento.toUpperCase() !== 'FACTURA') {
                tipoCombustibleField.style.display = 'none';
                tipoCombustibleSelect.removeAttribute('required');
                tipoCombustibleSelect.value = '';
                return;
            }

            if (currentTipoGasto === 'Combustible') {
                tipoCombustibleField.style.display = 'block';
                tipoCombustibleSelect.setAttribute('required', 'required');
            } else if (currentTipoGasto === 'Gasto Operativo') {
                tipoCombustibleField.style.display = 'none';
                tipoCombustibleSelect.removeAttribute('required');
                tipoCombustibleSelect.value = 'Gasolina';
            } else {
                tipoCombustibleField.style.display = 'none';
                tipoCombustibleSelect.removeAttribute('required');
                tipoCombustibleSelect.value = '';
            }

            updateCantidadField(currentTipoDocumento, currentTipoGasto);
            updateTaxFieldsVisibility(currentTipoDocumento, currentTipoGasto);
            updateTaxesAndTotal();
        }

        function updateTaxesAndTotal() {
            const tipoGastoSelect = document.getElementById('t_gasto');
            const tipoDocumentoSelect = document.getElementById('tipo_documento');
            const tipoCombustibleSelect = document.getElementById('tipo_combustible');
            const ivaInput = document.getElementById('iva');
            const idpInput = document.getElementById('idp');
            const inguatInput = document.getElementById('inguat');
            const subtotalInput = document.getElementById('subtotal');
            const totalFacturaInput = document.getElementById('total_factura');
            const cantidadInput = document.getElementById('cantidad');

            const tipoDocumento = tipoDocumentoSelect.value ? tipoDocumentoSelect.value.toUpperCase() : '';
            if (tipoDocumento !== 'FACTURA') {
                ivaInput.value = '';
                idpInput.value = '';
                inguatInput.value = '';
                subtotalInput.value = parseFloat(totalFacturaInput.value) || 0;
                return;
            }

            const tipoGasto = tipoGastoSelect.value;
            const tipoCombustible = tipoCombustibleSelect.value;
            const impuestos = impuestosPorTipoGasto[tipoGasto] || { iva: 0, idp: 0, idp_gasolina: 0, idp_diesel: 0, inguat: 0 };

            let totalBruto = parseFloat(totalFacturaInput.value) || 0;
            let iva = 0, idp = 0, inguat = 0;
            const cantidadGalones = parseFloat(cantidadInput.value) || 0;

            if (tipoGasto === 'Gasto Operativo' && cantidadGalones > 0) {
                idp = cantidadGalones * impuestos.idp;
            } else if (tipoGasto === 'Combustible' && cantidadGalones > 0) {
                if (tipoCombustible === 'Gasolina') {
                    idp = cantidadGalones * impuestos.idp_gasolina;
                } else if (tipoCombustible === 'Diesel') {
                    idp = cantidadGalones * impuestos.idp_diesel;
                } else {
                    idp = 0;
                }
            } else {
                idp = 0;
            }

            let subtotalSinImpuestos = totalBruto - idp;
            const ivaRate = impuestos.iva / 100;
            const inguatRate = impuestos.inguat / 100;
            const totalTaxRate = ivaRate + inguatRate;
            let subtotal = totalTaxRate > 0 ? subtotalSinImpuestos / (1 + totalTaxRate) : subtotalSinImpuestos;

            if (impuestos.iva > 0) {
                iva = subtotal * ivaRate;
            }

            if (impuestos.inguat > 0) {
                inguat = subtotal * inguatRate;
            }

            ivaInput.value = iva > 0 ? iva.toFixed(2) : '';
            idpInput.value = idp > 0 ? idp.toFixed(2) : '';
            inguatInput.value = inguat > 0 ? inguat.toFixed(2) : '';
            subtotalInput.value = subtotal.toFixed(2);

            updateTaxFieldsVisibility(tipoDocumento, tipoGasto);
        }

        function updateCuentaContableOptions() {
            const centroCostoSelect = document.getElementById('id_centro_costo');
            const cuentaContableSelect = document.getElementById('cuenta_contable');
            const selectedCentroCosto = centroCostoSelect.value;

            cuentaContableSelect.innerHTML = '<option value="">Selecciona una cuenta contable</option>';
            const cuentas = cuentasPorCentroCosto[selectedCentroCosto] || [];
            cuentas.forEach(cuenta => {
                const option = document.createElement('option');
                option.value = cuenta.nombre;
                option.textContent = cuenta.nombre;
                cuentaContableSelect.appendChild(option);
            });

            updateTaxesAndTotal();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const tipoDocumentoSelect = document.getElementById('tipo_documento');
            const tipoGastoSelect = document.getElementById('t_gasto');
            const tipoCombustibleSelect = document.getElementById('tipo_combustible');
            const totalFacturaInput = document.getElementById('total_factura');
            const cantidadInput = document.getElementById('cantidad');
            const centroCostoSelect = document.getElementById('id_centro_costo');

            const suggestedCentroCostoId = '<?php echo htmlspecialchars($data['suggested_centro_costo_id']); ?>';
            if (centroCostoSelect && suggestedCentroCostoId) {
                centroCostoSelect.value = suggestedCentroCostoId;
                updateCuentaContableOptions();
            }

            tipoDocumentoSelect.addEventListener('change', () => {
                updateForm_FIELDS(tipoDocumentoSelect.value);
                updateTipoCombustibleField(tipoDocumentoSelect.value, tipoGastoSelect.value);
                updateCantidadField(tipoDocumentoSelect.value, tipoGastoSelect.value);
                updateTaxFieldsVisibility(tipoDocumentoSelect.value, tipoGastoSelect.value);
                updateTaxesAndTotal();
            });

            tipoGastoSelect.addEventListener('change', () => {
                updateTipoCombustibleField(tipoDocumentoSelect.value, tipoGastoSelect.value);
                updateCantidadField(tipoDocumentoSelect.value, tipoGastoSelect.value);
                updateTaxFieldsVisibility(tipoDocumentoSelect.value, tipoGastoSelect.value);
                updateTaxesAndTotal();
            });

            tipoCombustibleSelect.addEventListener('change', () => {
                updateTaxesAndTotal();
            });

            totalFacturaInput.addEventListener('input', () => {
                updateTaxesAndTotal();
            });

            cantidadInput.addEventListener('input', () => {
                updateTaxesAndTotal();
            });

            centroCostoSelect.addEventListener('change', () => {
                updateCuentaContableOptions();
            });

            updateForm_FIELDS();
            updateTipoCombustibleField();
            updateCantidadField();
            updateTaxFieldsVisibility();
            updateTaxesAndTotal();
        });

        function editFactura(detalle) {
            document.getElementById('detalle_id').value = detalle.id || '';
            const tipoDocumentoSelect = document.getElementById('tipo_documento');
            tipoDocumentoSelect.value = detalle.tipo_documento || 'FACTURA';

            document.getElementById('no_factura').value = detalle.no_factura || '';
            document.getElementById('nombre_proveedor').value = detalle.nombre_proveedor || '';

            const nitDpiInput = document.getElementById('nit_dpi_input');
            const nitInput = document.getElementById('nit_proveedor');
            const dpiInput = document.getElementById('dpi');
            const tipoDocumento = detalle.tipo_documento ? detalle.tipo_documento.toUpperCase() : 'FACTURA';

            if (tipoDocumento === 'RECIBO') {
                nitDpiInput.value = detalle.dpi || '';
                dpiInput.value = detalle.dpi || '';
                nitInput.value = '';
            } else {
                nitDpiInput.value = detalle.nit_proveedor || '';
                nitInput.value = detalle.nit_proveedor || '';
                dpiInput.value = '';
            }

            const tGastoSelect = document.getElementById('t_gasto');
            const tipoGastoValue = detalle.t_gasto || 'Gasto Operativo';
            tGastoSelect.value = tipoGastoValue;

            document.getElementById('serie').value = detalle.serie || '';
            document.getElementById('cantidad').value = detalle.cantidad || '';
            document.getElementById('tipo_combustible').value = detalle.tipo_combustible || 'Gasolina';
            document.getElementById('fecha').value = detalle.fecha || '';
            document.getElementById('subtotal').value = detalle.p_unitario || 0;
            document.getElementById('total_factura').value = detalle.total_factura || 0;
            document.getElementById('iva').value = detalle.iva || 0;
            document.getElementById('idp').value = detalle.idp || 0;
            document.getElementById('inguat').value = detalle.inguat || 0;
            document.getElementById('id_centro_costo').value = detalle.id_centro_costo || '<?php echo htmlspecialchars($data['suggested_centro_costo_id']); ?>';
            updateCuentaContableOptions();
            document.getElementById('cuenta_contable').value = detalle.cuenta_contable || '';
            document.getElementById('archivos').value = '';

            nitDpiInput.removeEventListener('input', handleNitDpiInput);
            nitDpiInput.addEventListener('input', handleNitDpiInput);

            updateForm_FIELDS(detalle.tipo_documento);
            updateTipoCombustibleField(detalle.tipo_documento, tipoGastoValue);
            updateCantidadField(detalle.tipo_documento, tipoGastoValue);
            updateTaxFieldsVisibility(detalle.tipo_documento, tipoGastoValue);
            updateTaxesAndTotal();

            const changeEvent = new Event('change');
            tipoDocumentoSelect.dispatchEvent(changeEvent);
            tGastoSelect.dispatchEvent(changeEvent);

            form.style.display = 'flex';
            form.querySelector('button[type="submit"]').textContent = 'Actualizar';
            window.scrollTo({ top: form.offsetTop, behavior: 'smooth' });
        }

        function resetForm() {
            form.reset();
            form.style.display = 'none';
            document.getElementById('detalle_id').value = '';
            form.querySelector('button[type="submit"]').textContent = 'Guardar Cambios';
            updateForm_FIELDS();
            updateTipoCombustibleField();
            updateCantidadField();
            updateTaxFieldsVisibility();
            updateTaxesAndTotal();
        }

        const form = document.getElementById('facturaForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const files = document.getElementById('archivos').files;
            if (files.length > 0) {
                if (!validateFileTypes(files)) {
                    alert('Solo se permiten archivos PDF, PNG y JPG.');
                    return;
                }
            }

            const fechaFactura = document.getElementById('fecha').value;
            const fechaInicio = new Date(fechaInicioLiquidacion);
            const fechaFin = new Date(fechaFinLiquidacion);
            const fecha = new Date(fechaFactura);

            if (fechaInicio && fechaFin && fecha) {
                if (fecha < fechaInicio || fecha > fechaFin) {
                    alert(`La fecha de la factura debe estar entre ${fechaInicioLiquidacion} y ${fechaFinLiquidacion}.`);
                    return;
                }
            }

            const formData = new FormData(form);
            formData.append('id', '<?php echo htmlspecialchars($data['id']); ?>');

            try {
                const response = await fetch(`index.php?controller=liquidacion&action=updateCorreccion&id=<?php echo htmlspecialchars($data['id']); ?>`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Error al actualizar la factura');
                }

                const detalleId = result.detalle_id;
                const row = document.querySelector(`tr[data-id="${detalleId}"]`);
                const tipoDocumento = formData.get('tipo_documento').toUpperCase();
                row.querySelector('td[data-label="Tipo de Documento"]').textContent = formData.get('tipo_documento') || 'N/A';
                row.querySelector('td[data-label="Número Factura"]').textContent = formData.get('no_factura') || 'N/A';
                row.querySelector('td[data-label="Proveedor"]').textContent = formData.get('nombre_proveedor') || 'N/A';
                row.querySelector('td[data-label="NIT"]').textContent = tipoDocumento === 'RECIBO' ? 'N/A' : formData.get('nit_proveedor') || 'N/A';
                row.querySelector('td[data-label="DPI"]').textContent = tipoDocumento === 'RECIBO' ? formData.get('dpi') || 'N/A' : 'N/A';
                row.querySelector('td[data-label="Cantidad"]').textContent = tipoDocumento === 'COMPROBANTE' || formData.get('t_gasto') === 'Combustible' || formData.get('t_gasto') === 'Gasto Operativo' ? formData.get('cantidad') || 'N/A' : 'N/A';
                row.querySelector('td[data-label="Serie"]').textContent = tipoDocumento === 'COMPROBANTE' ? formData.get('serie') || 'N/A' : 'N/A';
                row.querySelector('td[data-label="Centro de Costo"]').textContent = document.querySelector(`#id_centro_costo option[value="${formData.get('id_centro_costo')}"]`).textContent;
                row.querySelector('td[data-label="Tipo de Gasto"]').textContent = formData.get('t_gasto') || 'N/A';
                row.querySelector('td[data-label="Tipo de Combustible"]').textContent = formData.get('t_gasto') === 'Combustible' ? formData.get('tipo_combustible') : formData.get('t_gasto') === 'Gasto Operativo' ? 'Gasolina' : 'N/A';
                row.querySelector('td[data-label="Cuenta Contable"]').textContent = formData.get('cuenta_contable') || 'N/A';
                row.querySelector('td[data-label="Fecha"]').textContent = formData.get('fecha') || 'N/A';
                row.querySelector('td[data-label="Subtotal"]').textContent = parseFloat(formData.get('subtotal')).toFixed(2);
                row.querySelector('td[data-label="IVA"]').textContent = tipoDocumento === 'FACTURA' ? parseFloat(formData.get('iva')).toFixed(2) : '0.00';
                row.querySelector('td[data-label="IDP"]').textContent = tipoDocumento === 'FACTURA' ? parseFloat(formData.get('idp')).toFixed(2) : '0.00';
                row.querySelector('td[data-label="INGUAT"]').textContent = tipoDocumento === 'FACTURA' ? parseFloat(formData.get('inguat')).toFixed(2) : '0.00';
                row.querySelector('td[data-label="Total Factura"]').textContent = parseFloat(formData.get('total_factura')).toFixed(2);

                const archivosCell = row.querySelector('td[data-label="Archivos"]');
                if (result.rutas_archivos && result.rutas_archivos.length > 0) {
                    let archivosHtml = '';
                    result.rutas_archivos.forEach(ruta => {
                        archivosHtml += `<div><a href="../${ruta}" target="_blank">Ver Archivo</a></div>`;
                    });
                    archivosCell.innerHTML = archivosHtml;
                } else {
                    archivosCell.innerHTML = 'N/A';
                }

                alert('Factura actualizada correctamente.');
                resetForm();
            } catch (error) {
                console.error('Error al actualizar factura:', error);
                alert(error.message || 'Error al actualizar la factura. Intenta de nuevo.');
            }
        });

        async function submitCorrections() {
            if (!confirm('¿Estás seguro de que deseas enviar las correcciones? Las facturas serán enviadas a Contabilidad para revisión.')) {
                return;
            }

            const formData = new FormData();
            formData.append('action', 'submit_corrections');

            try {
                const response = await fetch(`index.php?controller=liquidacion&action=updateCorreccion&id=<?php echo htmlspecialchars($data['id']); ?>`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Error al enviar las correcciones');
                }

                alert(result.message || 'Correcciones enviadas correctamente a Contabilidad.');
                setTimeout(() => {
                    window.location.href = 'index.php?controller=liquidacion&action=list&mode=correccion';
                }, 1000);
            } catch (error) {
                console.error('Error al enviar correcciones:', error);
                alert(error.message || 'Error al enviar las correcciones. Intenta de nuevo.');
            }
        }
    </script>
</body>
</html>