<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mantenimiento de Liquidaciones</title>
    <style>
      :root {
        --primary-color: #2d6a4f;
        --primary-dark: #1a4d3e;
        --primary-light: #52b788;
        --secondary-color: #40916c;
        --accent-color: #f39c12;
        --danger-color: #dc2626;
        --success-color: #16a34a;
        --background-color: #f5f7fa;
        --background-gradient: linear-gradient(135deg, #f5f7fa 0%, #e8f5e9 100%);
        --card-background: #ffffff;
        --text-color: #1e293b;
        --text-muted: #64748b;
        --border-color: #e2e8f0;
        --shadow-sm: 0 2px 8px rgba(45, 106, 79, 0.08);
        --shadow-md: 0 4px 16px rgba(45, 106, 79, 0.12);
        --shadow-lg: 0 8px 24px rgba(45, 106, 79, 0.15);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--background-gradient);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: var(--text-color);
        line-height: 1.6;
        margin: 0;
        padding: 1rem;
        transition: all 0.3s ease;
        min-height: 100vh;
      }

      /* Header Section */
      .page-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 2.5rem 1.5rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-lg);
        text-align: center;
      }

      h2 {
        color: white;
        margin: 0;
        font-size: 2rem;
        font-weight: 700;
        letter-spacing: -0.025em;
      }

      .page-subtitle {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.95rem;
        margin-top: 0.5rem;
      }

      /* Button Styles */
      button[onclick="showCreateForm()"],
      .toggle-btn {
        display: block;
        margin: 1.5rem auto;
        padding: 0.875rem 2rem;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: clamp(200px, 50%, 320px);
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
      }

      button[onclick="showCreateForm()"]::before,
      .toggle-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
      }

      button[onclick="showCreateForm()"]:hover::before,
      .toggle-btn:hover::before {
        left: 100%;
      }

      .toggle-btn {
        background: linear-gradient(135deg, var(--accent-color) 0%, #d97706 100%);
      }

      button[onclick="showCreateForm()"]:hover,
      .toggle-btn:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
      }

      button[onclick="showCreateForm()"]:active,
      .toggle-btn:active {
        transform: translateY(-1px);
      }

      /* Search Form Styles */
      #searchForm {
        width: 95%;
        max-width: 1300px;
        margin: 1.5rem auto;
        padding: 2rem;
        background: var(--card-background);
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1.25rem;
        align-items: end;
        border-top: 4px solid var(--primary-color);
      }

      #searchForm label {
        font-size: 0.875rem;
        color: var(--text-color);
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
      }

      #searchForm input {
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 0.875rem;
        width: 100%;
        transition: all 0.3s ease;
        background: #f8f9fa;
      }

      #searchForm input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(45, 106, 79, 0.1);
        background: white;
      }

      #searchForm button {
        padding: 0.75rem 1.25rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
      }

      #searchForm button[type="submit"] {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
      }

      #searchForm button[type="submit"]:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      #searchForm button[type="button"] {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
      }

      #searchForm button[type="button"]:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      /* Pagination Styles */
      #paginationControls {
        width: 95%;
        max-width: 1300px;
        margin: 1.5rem auto;
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
      }

      #paginationControls button {
        padding: 0.625rem 1.25rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 600;
        background: var(--primary-color);
        color: white;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
      }

      #paginationControls button:hover:not(:disabled) {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      #paginationControls button:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        transform: none;
        opacity: 0.6;
      }

      #paginationControls span {
        font-size: 0.9rem;
        color: var(--text-color);
        font-weight: 500;
        padding: 0.5rem 1rem;
        background: var(--card-background);
        border-radius: 8px;
        box-shadow: var(--shadow-sm);
      }

      /* Table Container */
      .table-container {
        width: 95%;
        max-width: 1300px;
        margin: 1.5rem auto;
        background: var(--card-background);
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        overflow: hidden;
        border-top: 4px solid var(--primary-color);
      }

      /* Table Styles */
      #liquidacionesTable,
      #correctedDetallesTable {
        width: 100%;
        border-collapse: collapse;
      }

      #correctedDetallesContainer {
        width: 95%;
        max-width: 1300px;
        margin: 1.5rem auto;
        overflow-x: auto;
        background: var(--card-background);
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        border-top: 4px solid var(--primary-color);
      }

      #liquidacionesTable thead,
      #correctedDetallesTable thead {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
      }

      #liquidacionesTable th,
      #liquidacionesTable td,
      #correctedDetallesTable th,
      #correctedDetallesTable td {
        padding: 1rem 1.25rem;
        text-align: left;
        font-size: 0.875rem;
        min-width: 100px;
      }

      #correctedDetallesTable th,
      #correctedDetallesTable td {
        white-space: nowrap;
      }

      #liquidacionesTable th,
      #correctedDetallesTable th {
        font-weight: 700;
        letter-spacing: 0.025em;
        text-transform: uppercase;
        font-size: 0.8rem;
      }

      #liquidacionesTable tbody tr,
      #correctedDetallesTable tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: all 0.2s ease;
      }

      #liquidacionesTable tbody tr:hover,
      #correctedDetallesTable tbody tr:hover {
        background: rgba(45, 106, 79, 0.05);
        transform: scale(1.01);
      }

      #liquidacionesTable td,
      #correctedDetallesTable td {
        color: var(--text-color);
      }

      /* Action Buttons in Table */
      #liquidacionesTable button,
      #correctedDetallesTable button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.813rem;
        font-weight: 600;
        margin: 0.25rem;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
      }

      #liquidacionesTable button.edit-btn,
      #correctedDetallesTable button.edit-btn {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
      }

      #liquidacionesTable button.edit-btn:hover,
      #correctedDetallesTable button.edit-btn:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      #liquidacionesTable button.delete-btn,
      #correctedDetallesTable button.delete-btn {
        background: linear-gradient(135deg, var(--danger-color) 0%, #b91c1c 100%);
        color: white;
      }

      #liquidacionesTable button.delete-btn:hover,
      #correctedDetallesTable button.delete-btn:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      #liquidacionesTable button.export-btn,
      #correctedDetallesTable button.export-btn {
        background: linear-gradient(135deg, var(--success-color) 0%, #15803d 100%);
        color: white;
      }

      #liquidacionesTable button.export-btn:hover,
      #correctedDetallesTable button.export-btn:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      #liquidacionesTable button.finalize-btn,
      #correctedDetallesTable button.finalize-btn {
        background: linear-gradient(135deg, var(--accent-color) 0%, #d97706 100%);
        color: white;
      }

      #liquidacionesTable button.finalize-btn:hover,
      #correctedDetallesTable button.finalize-btn:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      #liquidacionesTable button.view-btn,
      #correctedDetallesTable button.view-btn {
        background: #116f59a6;
        color: white;
      }

      #liquidacionesTable button.view-btn:hover,
      #correctedDetallesTable button.view-btn:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      /* Table Column Widths */
      #liquidacionesTable th:nth-child(1) { width: 5%; }
      #liquidacionesTable th:nth-child(2) { width: 15%; }
      #liquidacionesTable th:nth-child(3) { width: 12%; }
      #liquidacionesTable th:nth-child(4) { width: 12%; }
      #liquidacionesTable th:nth-child(5) { width: 12%; }
      #liquidacionesTable th:nth-child(6) { width: 12%; }
      #liquidacionesTable th:nth-child(7) { width: 12%; }
      #liquidacionesTable th:nth-child(8) { width: 12%; }
      #liquidacionesTable th:nth-child(9) { width: 20%; }

      #correctedDetallesTable th:nth-child(1) { width: 5%; }
      #correctedDetallesTable th:nth-child(2) { width: 8%; }
      #correctedDetallesTable th:nth-child(3) { width: 8%; }
      #correctedDetallesTable th:nth-child(4) { width: 10%; }
      #correctedDetallesTable th:nth-child(5) { width: 8%; }
      #correctedDetallesTable th:nth-child(6) { width: 8%; }
      #correctedDetallesTable th:nth-child(7) { width: 6%; }
      #correctedDetallesTable th:nth-child(8) { width: 6%; }
      #correctedDetallesTable th:nth-child(9) { width: 10%; }
      #correctedDetallesTable th:nth-child(10) { width: 8%; }
      #correctedDetallesTable th:nth-child(11) { width: 8%; }
      #correctedDetallesTable th:nth-child(12) { width: 10%; }
      #correctedDetallesTable th:nth-child(13) { width: 8%; }
      #correctedDetallesTable th:nth-child(14) { width: 8%; }
      #correctedDetallesTable th:nth-child(15) { width: 6%; }
      #correctedDetallesTable th:nth-child(16) { width: 6%; }
      #correctedDetallesTable th:nth-child(17) { width: 6%; }
      #correctedDetallesTable th:nth-child(18) { width: 8%; }
      #correctedDetallesTable th:nth-child(19) { width: 8%; }
      #correctedDetallesTable th:nth-child(20) { width: 10%; }
      #correctedDetallesTable th:nth-child(21) { width: 15%; }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1002;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: var(--card-background);
        border-radius: 16px;
        padding: 2rem;
        width: 90%;
        max-width: 650px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
        position: relative;
        border-top: 4px solid var(--primary-color);
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-content h2 {
        font-size: 1.75rem;
        margin-top: 0;
        color: var(--primary-color);
        margin-bottom: 1.5rem;
      }

      .close-modal {
        position: absolute;
        top: 1.25rem;
        right: 1.25rem;
        font-size: 1.75rem;
        cursor: pointer;
        color: var(--text-muted);
        transition: all 0.2s ease;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.05);
      }

      .close-modal:hover {
        color: var(--danger-color);
        background: rgba(220, 38, 38, 0.1);
        transform: rotate(90deg);
      }

      #liquidacionFormInner {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      #liquidacionFormInner select,
      #liquidacionFormInner input {
        padding: 0.875rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 0.875rem;
        width: 100%;
        transition: all 0.3s ease;
        background: #f8f9fa;
      }

      #liquidacionFormInner select:focus,
      #liquidacionFormInner input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(45, 106, 79, 0.1);
        background: white;
      }

      #liquidacionFormInner .error {
        color: var(--danger-color);
        font-size: 0.813rem;
        display: none;
        padding: 0.75rem;
        background: rgba(220, 38, 38, 0.1);
        border-radius: 8px;
        border-left: 4px solid var(--danger-color);
      }

      #liquidacionFormInner .success {
        color: var(--success-color);
        font-size: 0.813rem;
        display: none;
        padding: 0.75rem;
        background: rgba(22, 163, 74, 0.1);
        border-radius: 8px;
        border-left: 4px solid var(--success-color);
      }

      #liquidacionFormInner button {
        padding: 0.875rem 1.5rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
      }

      #liquidacionFormInner button[type="submit"] {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
      }

      #liquidacionFormInner button[type="submit"]:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      #liquidacionFormInner button[type="button"] {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
      }

      #liquidacionFormInner button[type="button"]:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      /* Modal Styles for Finalized and Select Liquidation */
      #finalizedDetailModal,
      #selectLiquidationModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
        z-index: 1005;
        backdrop-filter: blur(4px);
      }

      #finalizedDetailModal.active,
      #selectLiquidationModal.active {
        display: flex;
      }

      #finalizedDetailModal .modal-content,
      #selectLiquidationModal .modal-content {
        background: var(--card-background);
        padding: 2rem;
        border-radius: 16px;
        width: 90%;
        max-width: 550px;
        text-align: center;
        box-shadow: var(--shadow-lg);
        border-top: 4px solid var(--primary-color);
      }

      #finalizedDetailModal h3,
      #selectLiquidationModal h3 {
        color: var(--primary-color);
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
        font-weight: 700;
      }

      #liquidationOptions {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 0.875rem;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        background: #f8f9fa;
        max-height: 320px;
        overflow-y: auto;
      }

      #liquidationOptions:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(45, 106, 79, 0.1);
        background: white;
      }

      #finalizedDetailModal button,
      #selectLiquidationModal button {
        padding: 0.875rem 1.5rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 600;
        width: 48%;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
      }

      #finalizedDetailModal button:not([onclick="closeFinalizedDetailModal()"]),
      #selectLiquidationModal button:not([onclick="closeSelectLiquidationModal()"]) {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        margin-right: 4%;
      }

      #finalizedDetailModal button:not([onclick="closeFinalizedDetailModal()"]):hover,
      #selectLiquidationModal button:not([onclick="closeSelectLiquidationModal()"]):hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      #finalizedDetailModal button[onclick="closeFinalizedDetailModal()"],
      #selectLiquidationModal button[onclick="closeSelectLiquidationModal()"] {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
      }

      #finalizedDetailModal button[onclick="closeFinalizedDetailModal()"]:hover,
      #selectLiquidationModal button[onclick="closeSelectLiquidationModal()"]:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      #finalizedDetailModal p {
        color: var(--text-muted);
        margin-bottom: 1.5rem;
        line-height: 1.6;
      }

      /* Responsive Styles */
      @media (max-width: 768px) {
        body {
          padding: 0.5rem;
        }

        h2 {
          font-size: 1.5rem;
        }

        .page-header {
          padding: 1.5rem 1rem;
        }

        .table-container {
          border-radius: 12px;
        }

        #liquidacionesTable thead,
        #correctedDetallesTable thead {
          display: none;
        }

        #liquidacionesTable tbody tr,
        #correctedDetallesTable tbody tr {
          display: block;
          margin-bottom: 1rem;
          border: 2px solid var(--border-color);
          border-radius: 12px;
          background: var(--card-background);
          box-shadow: var(--shadow-sm);
          padding: 0.75rem;
        }

        #liquidacionesTable tbody tr:hover,
        #correctedDetallesTable tbody tr:hover {
          transform: scale(1);
          box-shadow: var(--shadow-md);
        }

        #liquidacionesTable tbody td,
        #correctedDetallesTable tbody td {
          display: flex;
          justify-content: space-between;
          align-items: center;
          text-align: right;
          padding: 0.75rem 0.5rem;
          font-size: 0.813rem;
          position: relative;
          border-bottom: 1px solid var(--border-color);
          min-width: auto;
        }

        #liquidacionesTable tbody td:last-child,
        #correctedDetallesTable tbody td:last-child {
          border-bottom: none;
        }

        #liquidacionesTable tbody td:before,
        #correctedDetallesTable tbody td:before {
          content: attr(data-label);
          font-weight: 700;
          color: var(--primary-color);
          text-align: left;
          flex: 1;
        }

        #liquidacionesTable tbody td[data-label="Total Gastos"]:before {
          content: "Total Gastos:";
        }

        .modal-content {
          width: 95%;
          padding: 1.5rem;
        }

        #liquidacionesTable button,
        #correctedDetallesTable button {
          width: 100%;
          margin: 0.25rem 0;
        }

        #searchForm {
          grid-template-columns: 1fr;
          padding: 1.5rem;
        }

        #finalizedDetailModal button,
        #selectLiquidationModal button {
          width: 100%;
          margin: 0.5rem 0;
        }

        #finalizedDetailModal button:not([onclick="closeFinalizedDetailModal()"]),
        #selectLiquidationModal button:not([onclick="closeSelectLiquidationModal()"]) {
          margin-right: 0;
        }
      }

      @media (max-width: 480px) {
        h2 {
          font-size: 1.25rem;
        }

        button[onclick="showCreateForm()"],
        .toggle-btn {
          width: 100%;
          padding: 0.75rem 1.5rem;
        }

        .page-header {
          padding: 1.25rem 0.75rem;
        }
      }

      #searchForm select {
    padding: 0.75rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    font-size: 0.875rem;
    width: 100%;
    transition: all 0.3s ease;
    background: #f8f9fa;
    cursor: pointer;
}

#searchForm select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(45, 106, 79, 0.1);
    background: white;
}

/* Estilos para liquidaciones antiguas */
#liquidacionesTable tbody tr.liquidacion-antigua {
    background-color: #f8f9fa !important;
    color: #6c757d !important;
    opacity: 0.7;
}

#liquidacionesTable tbody tr.liquidacion-antigua:hover {
    background-color: #e9ecef !important;
    transform: none !important;
}

#liquidacionesTable tbody tr.liquidacion-antigua td {
    color: #6c757d !important;
}

.auto-finalized-msg {
    color: #6c757d;
    font-style: italic;
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    background-color: #e9ecef;
    border-radius: 4px;
    text-align: center;
}

/* Deshabilitar botones en liquidaciones antiguas */
#liquidacionesTable tbody tr.liquidacion-antigua button {
    opacity: 0.5;
    /* cursor: not-allowed !important;
    pointer-events: none; */
}

#liquidacionesTable tbody tr.liquidacion-antigua button:hover {
    transform: none !important;
    box-shadow: none !important;
}
    </style>
    <script>
      const userPermissions = {
          create_liquidaciones: <?php echo json_encode($usuarioModel->tienePermiso($usuario, 'create_liquidaciones')); ?>,
          autorizar_liquidaciones: <?php echo json_encode($usuarioModel->tienePermiso($usuario, 'autorizar_liquidaciones')); ?>,
          revisar_liquidaciones: <?php echo json_encode($usuarioModel->tienePermiso($usuario, 'revisar_liquidaciones')); ?>
      };
      const currentUserId = <?php echo json_encode($_SESSION['user_id']); ?>;
    </script>
  </head>
  <body>
    <?php include '../views/partials/menu.php'; ?>
    
    <div class="page-header">
      <h2>Lista de Liquidaciones</h2>
      <div class="page-subtitle">Gesti√≥n y control de liquidaciones</div>
    </div>

    <?php if ($usuarioModel->tienePermiso($usuario, 'create_liquidaciones') &&
    strtoupper($usuario['rol']) !== 'SUPERVISOR' && strtoupper($usuario['rol']) !== 'CONTABILIDAD'): ?>
    <button onclick="showCreateForm()">‚ûï Crear Liquidaci√≥n</button>
    <?php endif; ?>

    <?php
    $isSupervisorRole = false;
    if (isset($usuario['id_rol'])) {
        $rolModel = new Role();
        $roleData = $rolModel->getRolById($usuario['id_rol']);
        if ($roleData) {
            $roleName = strtoupper($roleData['nombre'] ?? '');
            $roleDescription = strtoupper($roleData['descripcion'] ?? '');
            $isSupervisorRole = strpos($roleName, 'SUPERVISOR') !== false || strpos($roleDescription, 'SUPERVISOR') !== false;
        }
    }
    ?>
    <?php if ($isSupervisorRole && isset($_GET['mode']) && $_GET['mode'] === 'autorizar'): ?>
    <button
      id="toggleViewBtn"
      class="toggle-btn"
      onclick="toggleLiquidationView()"
    >
      üîÑ Ver Liquidaciones Corregidas
    </button>
    <?php endif; ?>

    <div id="liquidacionesSection">
      <div id="searchForm">
  <div>
    <label for="searchId">ID:</label>
    <input type="number" id="searchId" placeholder="Buscar por ID" />
  </div>
  <div>
    <label for="searchCajaChica">Caja Chica:</label>
    <input
      type="text"
      id="searchCajaChica"
      placeholder="Buscar por Caja Chica"
    />
  </div>
  <div>
    <label for="searchFechaInicio">Fecha Inicio:</label>
    <input type="date" id="searchFechaInicio" />
  </div>
  <div>
    <label for="searchFechaFin">Fecha Fin:</label>
    <input type="date" id="searchFechaFin" />
  </div>
  <!-- NUEVO CAMPO ESTADO -->
  <div>
    <label for="searchEstado">Estado:</label>
    <select id="searchEstado">
      <option value="">Todos los estados</option>
      <option value="EN_PROCESO">En Proceso</option>
      <option value="PENDIENTE_REVISION_CONTABILIDAD">Pendiente Revisi√≥n Contabilidad</option>
      <option value="PENDIENTE_AUTORIZACION">Pendiente Autorizaci√≥n</option>
      <option value="FINALIZADO">Finalizado</option>
      <option value="EXPIRADO">Expirado</option> <!-- NUEVO ESTADO -->
    </select>
  </div>
  <button type="submit" onclick="applySearch()">üîç Buscar</button>
  <button type="button" onclick="resetSearch()">üóëÔ∏è Limpiar</button>
</div>

      <div class="table-container">
        <table id="liquidacionesTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Caja Chica</th>
              <th>Fecha Creaci√≥n</th>
              <th>Fecha Inicio</th>
              <th>Fecha Fin</th>
              <th>Total Gastos</th>
              <th>Monto Total</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="paginationControls"></div>
    </div>

    <div id="correctedDetallesSection" style="display: none">
      <div class="page-header">
        <h2>Detalles de Liquidaciones Corregidas</h2>
        <div class="page-subtitle">Revisi√≥n de correcciones pendientes</div>
      </div>
      
      <div id="correctedDetallesContainer">
        <table id="correctedDetallesTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Archivos</th>
              <th>Tipo de Documento</th>
              <th>No. Factura</th>
              <th>Proveedor</th>
              <th>NIT</th>
              <th>DPI</th>
              <th>Cantidad</th>
              <th>Serie</th>
              <th>Centro de Costo</th>
              <th>Tipo de Gasto</th>
              <th>Tipo de Combustible</th>
              <th>Cuenta Contable</th>
              <th>Fecha</th>
              <th>Subtotal</th>
              <th>IVA</th>
              <th>IDP</th>
              <th>INGUAT</th>
              <th>Total Bruto</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">√ó</span>
        <div id="modalForm"></div>
      </div>
    </div>

    <div id="finalizedDetailModal" class="modal">
      <div class="modal-content">
        <h3>üìã Liquidaci√≥n Finalizada</h3>
        <p id="finalizedDetailMessage"></p>
        <div id="finalizedDetailOptions" style="display: flex; flex-direction: column; gap: 10px"></div>
        <button onclick="closeFinalizedDetailModal()">Cancelar</button>
      </div>
    </div>

    <div id="selectLiquidationModal" class="modal">
      <div class="modal-content">
        <h3>üìù Selecciona una liquidaci√≥n en proceso</h3>
        <div id="liquidationOptions" style="display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto;"></div>
        <button onclick="closeSelectLiquidationModal()">Cancelar</button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
    try {
        window.userPermissions = window.userPermissions || {
            create_liquidaciones: <?php echo json_encode($usuarioModel->tienePermiso($usuario, 'create_liquidaciones')); ?>,
            autorizar_liquidaciones: <?php echo json_encode($usuarioModel->tienePermiso($usuario, 'autorizar_liquidaciones')); ?>,
            revisar_liquidaciones: <?php echo json_encode($usuarioModel->tienePermiso($usuario, 'revisar_liquidaciones')); ?>
        }
        window.userRole = window.userRole || <?php echo json_encode($usuario['rol'] ?? ''); ?>;
        window.currentUserId = <?php echo json_encode($_SESSION['user_id'] ?? null); ?>;
        window.userId = '<?php echo htmlspecialchars($_SESSION['user_id'] ?? '', ENT_QUOTES, 'UTF-8'); ?>';
    } catch (e) {
        console.error('Error initializing user data:', e);
        window.userPermissions = window.userPermissions || {};
        window.userRole = '';
        window.currentUserId = null;
        window.userId = '';
    }
    </script>

    <script src="../views/js/liquidaciones.js"></script>
  </body>
</html>